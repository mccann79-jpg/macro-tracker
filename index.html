<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Macro Calculator</title>
    
    <!-- PWA / Home Screen Icon Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Macros">
    <meta name="theme-color" content="#2c5282">
    
    <!-- App Icon (embedded as data URL) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%231e3a5f;stop-opacity:1'/><stop offset='100%25' style='stop-color:%232c5282;stop-opacity:1'/></linearGradient></defs><rect width='180' height='180' fill='url(%23grad)'/><circle cx='90' cy='70' r='35' fill='%233b82f6' opacity='0.9'/><circle cx='65' cy='115' r='25' fill='%23f59e0b' opacity='0.9'/><circle cx='115' cy='115' r='25' fill='%2310b981' opacity='0.9'/><text x='90' y='150' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='white' text-anchor='middle'>MACROS</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><defs><linearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%231e3a5f;stop-opacity:1'/><stop offset='100%25' style='stop-color:%232c5282;stop-opacity:1'/></linearGradient></defs><rect width='180' height='180' fill='url(%23grad)'/><circle cx='90' cy='70' r='35' fill='%233b82f6' opacity='0.9'/><circle cx='65' cy='115' r='25' fill='%23f59e0b' opacity='0.9'/><circle cx='115' cy='115' r='25' fill='%2310b981' opacity='0.9'/><text x='90' y='150' font-family='Arial,sans-serif' font-size='20' font-weight='bold' fill='white' text-anchor='middle'>MACROS</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            max-width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .nav-btn {
            flex: 1;
            background: #f8f9fa;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }

        .nav-btn:hover {
            background: #e9ecef;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(44, 82, 130, 0.4);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 3px solid #2c5282;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #2c5282;
        }

        .btn {
            background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 82, 130, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            padding: 6px 12px;
            font-size: 0.85rem;
            width: auto;
        }

        .btn-success {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }

        .food-list {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .food-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2c5282;
        }

        .food-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .food-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .food-macros {
            font-size: 0.85rem;
            color: #666;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 8px;
        }

        .meal-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .meal-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .meal-food-name {
            font-weight: 700;
            color: #2c5282;
            font-size: 1.1rem;
        }

        .portion-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .portion-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portion-input input {
            flex: 1;
        }

        .portion-input select {
            flex: 1;
        }

        .macro-display {
            background: linear-gradient(135deg, #e8eef5 0%, #d4dce8 100%);
            padding: 12px;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }

        .macro-item {
            display: flex;
            flex-direction: column;
        }

        .macro-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .macro-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
        }

        .total-macros {
            background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .total-macros h2 {
            color: white;
            border: none;
            margin-bottom: 20px;
        }

        .total-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .total-item {
            display: flex;
            flex-direction: column;
        }

        .total-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .total-value {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .saved-meal-item {
            background: white;
            border: 2px solid #2c5282;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .saved-meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .saved-meal-name {
            font-weight: 700;
            color: #2c5282;
            font-size: 1.2rem;
        }

        .meal-stats {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .day-meal-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px !important;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }

            .total-grid,
            .macro-display {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 2rem;
            }

            .navigation {
                flex-direction: column;
            }
            
            /* Make tables horizontally scrollable on mobile */
            .food-list, #savedMealsList, #dayMealsList {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Prevent table content from wrapping */
            table {
                min-width: 600px;
            }
            
            /* Smaller text on mobile tables */
            table {
                font-size: 0.8rem !important;
            }
            
            table th, table td {
                padding: 6px 4px !important;
                white-space: nowrap;
            }
            
            /* Compact buttons on mobile */
            .btn-success, .btn-danger {
                padding: 3px 6px !important;
                font-size: 0.75rem !important;
            }
            
            /* Stack PIN overlay buttons vertically on mobile */
            #pinOverlay > div {
                padding: 20px !important;
            }
            
            /* Smaller meal builder table */
            #mealBuilderTableBody input[type="number"],
            #mealBuilderTableBody select {
                font-size: 0.75rem !important;
                padding: 4px !important;
            }
            
            /* Adjust daily totals for mobile */
            .total-macros h2 {
                font-size: 1.2rem;
            }
            
            .total-value {
                font-size: 2rem !important;
            }
            
            .total-label {
                font-size: 0.75rem;
            }
            
            /* Make clear/undo buttons stack on very small screens */
            @media (max-width: 400px) {
                .total-macros > div:first-child {
                    flex-direction: column !important;
                    gap: 10px;
                }
                
                .total-macros > div:first-child > div {
                    width: 100%;
                    flex-direction: column !important;
                }
                
                #clearDayBtn, #undoClearBtn {
                    width: 100% !important;
                }
            }
            
            /* Portion controls in day meals table */
            .portion-input {
                flex-direction: column !important;
                gap: 4px;
            }
            
            .portion-input input,
            .portion-input select {
                font-size: 0.75rem !important;
            }
            
            /* Food Database page specific fixes */
            .form-group label {
                font-size: 0.9rem;
                word-break: break-word;
            }
            
            .form-group small {
                font-size: 0.75rem !important;
                display: block;
                word-break: break-word;
            }
            
            .form-group input,
            .form-group select {
                font-size: 0.9rem !important;
                max-width: 100%;
            }
            
            /* Prevent long text overflow */
            label, small, p {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Make select dropdowns shorter text */
            #servingUnit option {
                font-size: 0.85rem;
            }
            
            /* Card titles on mobile */
            .card h2 {
                font-size: 1.2rem !important;
            }
            
            /* Reduce card padding on mobile */
            .card {
                padding: 16px !important;
            }
            
            /* Make form buttons full width on mobile */
            .btn {
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>
<body>
    <!-- PIN Entry Overlay -->
    <div id="pinOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 40px; border-radius: 16px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="color: #2c5282; margin-bottom: 10px;">üîê Enter Your PIN</h2>
            <p style="color: #666; margin-bottom: 30px; font-size: 0.9rem;">4-digit PIN to sync your data across devices</p>
            
            <input type="tel" id="pinInput" maxlength="4" pattern="[0-9]*" 
                style="width: 100%; padding: 20px; font-size: 2rem; text-align: center; border: 3px solid #2c5282; border-radius: 12px; letter-spacing: 10px; font-weight: bold;"
                placeholder="----"
                autocomplete="off">
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="submitPin()" style="flex: 1; background: linear-gradient(135deg, #2c5282 0%, #1e3a5f 100%); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Unlock
                </button>
                <button onclick="changePin()" style="flex: 1; background: #6c757d; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                    Change PIN
                </button>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.85rem; color: #999;">
                First time? Enter any 4-digit PIN to create your account.
            </p>
        </div>
    </div>

    <div class="container">
        <h1>üçΩÔ∏è Macro Calculator</h1>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-btn active" onclick="showPage('database')">Food Database</button>
            <button class="nav-btn" onclick="showPage('meals')">Create Meal</button>
            <button class="nav-btn" onclick="showPage('day')">My Day</button>
        </div>

        <!-- Food Database Page -->
        <div id="databasePage" class="page active">
            <div class="main-grid">
                <!-- Add Food Section -->
                <div class="card">
                    <h2>Add Food</h2>
                    <form id="addFoodForm">
                        <input type="hidden" id="editingFoodId" value="">
                        
                        <div class="form-group">
                            <label for="foodName">Food Name</label>
                            <input type="text" id="foodName" required placeholder="e.g., Chicken Breast">
                        </div>
                        
                        <div class="form-group">
                            <label>Serving Size</label>
                            <div class="form-row">
                                <input type="number" id="servingAmount" step="0.1" required min="0.1" placeholder="1">
                                <select id="servingUnit" required>
                                    <option value="g">g</option>
                                    <option value="oz">oz</option>
                                    <option value="lb">lb</option>
                                    <option value="cup">cup</option>
                                    <option value="tbsp">tbsp</option>
                                    <option value="tsp">tsp</option>
                                    <option value="ml">ml</option>
                                    <option value="fl_oz">fl oz</option>
                                    <option value="piece">piece</option>
                                    <option value="serving">serving</option>
                                </select>
                            </div>
                            <small style="color: #666; font-size: 0.85rem;">Nutrition facts per serving size</small>
                        </div>

                        <div class="form-group">
                            <label for="protein">Protein (g)</label>
                            <input type="number" id="protein" step="0.1" required min="0">
                        </div>

                        <div class="form-group">
                            <label for="carbs">Carbs (g)</label>
                            <input type="number" id="carbs" step="0.1" required min="0">
                        </div>

                        <div class="form-group">
                            <label for="fats">Fats (g)</label>
                            <input type="number" id="fats" step="0.1" required min="0">
                        </div>

                        <div class="form-group">
                            <label for="fiber">Fiber (g) <span style="font-weight: normal; color: #999;">(optional)</span></label>
                            <input type="number" id="fiber" step="0.1" min="0" value="0">
                        </div>

                        <div class="form-group">
                            <label for="calories">Calories <span style="font-weight: normal; color: #999;">(optional)</span></label>
                            <input type="number" id="calories" step="1" min="0" placeholder="Auto-calculated if blank">
                            <small style="color: #666; font-size: 0.85rem;">Auto: (P √ó 4) + (C √ó 4) + (F √ó 9)</small>
                        </div>

                        <button type="submit" class="btn" id="submitFoodBtn">Add to Database</button>
                        <button type="button" class="btn" id="cancelEditBtn" style="display: none; margin-top: 10px; background: #6c757d;" onclick="cancelEdit()">Cancel Edit</button>
                    </form>
                </div>

                <!-- Food List Section -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                        <h2 style="margin-bottom: 0;">My Foods</h2>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-success" onclick="exportFoodDatabase()" style="padding: 8px 12px; font-size: 0.85rem; white-space: nowrap;">‚¨á Export</button>
                            <button type="button" class="btn btn-success" onclick="document.getElementById('importFileInput').click()" style="padding: 8px 12px; font-size: 0.85rem; white-space: nowrap;">‚¨Ü Import</button>
                            <input type="file" id="importFileInput" accept=".csv" style="display: none;" onchange="importFoodDatabase(event)">
                        </div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="form-group">
                        <input type="text" id="foodSearchInput" placeholder="Search foods..." 
                            style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;"
                            onkeyup="filterFoodList()">
                    </div>
                    
                    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                        <div class="food-list" id="foodList" style="max-height: 600px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Meal Page -->
        <div id="mealsPage" class="page">
            <div class="card" style="margin-bottom: 20px;">
                <h2 id="mealBuilderTitle">Build Your Meal</h2>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="mealName">Meal Name</label>
                        <input type="text" id="mealName" placeholder="e.g., Breakfast Bowl">
                        <input type="hidden" id="editingMealId" value="">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="totalServings">Total Servings</label>
                        <input type="number" id="totalServings" min="1" step="1" value="1" placeholder="Servings">
                    </div>
                </div>

                <!-- Meal Builder Table -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background: #2c5282; color: white;">
                                <th style="padding: 10px; text-align: left; border-radius: 8px 0 0 0; min-width: 200px;">Food</th>
                                <th style="padding: 10px; text-align: center; min-width: 100px;">Amount</th>
                                <th style="padding: 10px; text-align: center; min-width: 100px;">Unit</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">Protein</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">Carbs</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">Fats</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">Fiber</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">Calories</th>
                                <th style="padding: 10px; text-align: center; width: 80px;">P/Cal</th>
                                <th style="padding: 10px; text-align: center; border-radius: 0 8px 0 0; width: 60px;"></th>
                            </tr>
                        </thead>
                        <tbody id="mealBuilderTableBody">
                            <!-- Rows will be added here dynamically -->
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; border-top: 3px solid #2c5282;">
                                <td colspan="3" style="padding: 12px; font-weight: 700; font-size: 1.1rem; color: #333;">TOTAL</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #3b82f6; font-size: 1.1rem;" id="totalProteinTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #f59e0b; font-size: 1.1rem;" id="totalCarbsTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #10b981; font-size: 1.1rem;" id="totalFatsTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #666; font-size: 1.1rem;" id="totalFiberTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #333; font-size: 1.1rem;" id="totalCaloriesTable">0</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #333; font-size: 1.1rem;" id="totalPCalTable">0</td>
                                <td></td>
                            </tr>
                            <tr style="background: #e8ebf7; border-top: 2px solid #2c5282;">
                                <td colspan="3" style="padding: 12px; font-weight: 700; font-size: 1rem; color: #3b82f6;">PER SERVING</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #3b82f6;" id="perServingProteinTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #f59e0b;" id="perServingCarbsTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #10b981;" id="perServingFatsTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #666;" id="perServingFiberTable">0g</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #333;" id="perServingCaloriesTable">0</td>
                                <td style="padding: 12px; text-align: center; font-weight: 700; color: #333;" id="perServingPCalTable">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Add Food Row -->
                <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="selectFoodForMeal">Add Food to Meal</label>
                            <input type="text" id="searchFoodForMeal" placeholder="Search foods..." 
                                style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 8px;"
                                onkeyup="filterMealFoodDropdown()">
                            <select id="selectFoodForMeal" size="5" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                                <option value="">Choose a food...</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button type="button" class="btn" id="addToMealBuilder" style="width: 100%;">+ Add</button>
                        </div>
                    </div>
                </div>

                <!-- Save/Cancel Buttons -->
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn" id="saveMealBtn" style="flex: 1;">Save Meal</button>
                    <button type="button" class="btn" id="cancelMealEditBtn" style="flex: 1; background: #6c757d; display: none;" onclick="cancelMealEdit()">Cancel</button>
                </div>
            </div>

            <!-- Saved Meals Section -->
            <div class="card">
                <h2>Saved Meals</h2>
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <div id="savedMealsList"></div>
                </div>
            </div>
        </div>

        <!-- My Day Page -->
        <div id="dayPage" class="page">
            <!-- Day Totals at Top -->
            <div class="total-macros" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">Daily Totals</h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="btn btn-danger" id="clearDayBtn" onclick="clearDay()" style="padding: 8px 12px; font-size: 0.85rem; width: auto; white-space: nowrap;">Clear Day</button>
                        <button type="button" class="btn btn-success" id="undoClearBtn" onclick="undoClear()" style="padding: 8px 12px; font-size: 0.85rem; width: auto; display: none; white-space: nowrap;">Undo Clear</button>
                    </div>
                </div>
                <div class="total-grid">
                    <div class="total-item">
                        <div class="total-label">PROTEIN</div>
                        <div class="total-value" id="dayProtein">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;" id="dayProteinPct">0%</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">CARBS</div>
                        <div class="total-value" id="dayCarbs">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;" id="dayCarbsPct">0%</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">FATS</div>
                        <div class="total-value" id="dayFats">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;" id="dayFatsPct">0%</div>
                    </div>
                    <div class="total-item">
                        <div class="total-label">CALORIES</div>
                        <div class="total-value" id="dayCalories">0</div>
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 4px;">Total</div>
                    </div>
                </div>
                <div style="margin-top: 20px; font-size: 1.2rem;">
                    Fiber: <span id="dayFiber" style="font-weight: 700;">0</span>g
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h2>Add to Today</h2>
                
                <div class="form-group">
                    <label>Add From:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn" style="flex: 1; padding: 8px;" id="selectMealTypeBtn" onclick="setDayAddType('meal')">Saved Meals</button>
                        <button type="button" class="btn" style="flex: 1; padding: 8px; background: #6c757d;" id="selectFoodTypeBtn" onclick="setDayAddType('food')">Individual Foods</button>
                    </div>
                </div>

                <div id="mealSelectSection">
                    <div class="form-group">
                        <label for="selectMealForDay">Select Saved Meal</label>
                        <input type="text" id="searchMealForDay" placeholder="Search meals..." 
                            style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 8px;"
                            onkeyup="filterDayMealDropdown()">
                        <select id="selectMealForDay" size="5" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Choose a meal...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount</label>
                        <div class="form-row">
                            <input type="number" id="mealServingsForDay" min="0.1" step="0.1" value="1">
                            <select id="mealUnitForDay">
                                <option value="serving">servings</option>
                                <option value="g">grams (g)</option>
                                <option value="oz">ounces (oz)</option>
                                <option value="lb">pounds (lb)</option>
                                <option value="cup">cups</option>
                                <option value="tbsp">tablespoons</option>
                                <option value="tsp">teaspoons</option>
                                <option value="piece">pieces</option>
                            </select>
                        </div>
                        <small style="color: #666; font-size: 0.85rem;">Choose servings or measure by weight/volume</small>
                    </div>

                    <button type="button" class="btn" id="addMealToDay">Add Meal to Day</button>
                </div>

                <div id="foodSelectSection" style="display: none;">
                    <div class="form-group">
                        <label for="selectFoodForDay">Select Food</label>
                        <input type="text" id="searchFoodForDay" placeholder="Search foods..." 
                            style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; margin-bottom: 8px;"
                            onkeyup="filterDayFoodDropdown()">
                        <select id="selectFoodForDay" size="5" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem;">
                            <option value="">Choose a food...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Amount</label>
                        <div class="form-row">
                            <input type="number" id="foodAmountForDay" min="0.1" step="0.1" value="1">
                            <select id="foodUnitForDay">
                                <option value="g">g</option>
                                <option value="oz">oz</option>
                                <option value="lb">lb</option>
                                <option value="cup">cup</option>
                                <option value="tbsp">tbsp</option>
                                <option value="tsp">tsp</option>
                                <option value="ml">ml</option>
                                <option value="fl_oz">fl oz</option>
                                <option value="piece">piece</option>
                                <option value="serving">serving</option>
                            </select>
                        </div>
                    </div>

                    <button type="button" class="btn" id="addFoodToDay">Add Food to Day</button>
                </div>
            </div>

            <div class="card">
                <h2>Today's Meals</h2>
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
                    <div id="dayMealsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBYGJvIXh281SPNkBfRO2coTHnIJjE_Qqw",
            authDomain: "macro-calculator-a65ef.firebaseapp.com",
            databaseURL: "https://macro-calculator-a65ef-default-rtdb.firebaseio.com",
            projectId: "macro-calculator-a65ef",
            storageBucket: "macro-calculator-a65ef.firebasestorage.app",
            messagingSenderId: "817648356788",
            appId: "1:817648356788:web:6dd31d588129d9d54a76e1",
            measurementId: "G-NKH4TTLDT2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let userPin = localStorage.getItem('userPin') || null;
        let firebaseRef = null;

        // Unit conversion constants (to grams or ml)
        const UNIT_CONVERSIONS = {
            'g': 1,
            'oz': 28.3495,
            'lb': 453.592,
            'cup': 240,  // ml for liquids, varies for solids
            'tbsp': 15,  // ml
            'tsp': 5,    // ml
            'ml': 1,
            'fl_oz': 29.5735,
            'piece': 1,  // individual items (eggs, apples, etc.)
            'serving': 1  // placeholder, user defines the weight
        };

        const UNIT_LABELS = {
            'g': 'g',
            'oz': 'oz',
            'lb': 'lb',
            'cup': 'cup',
            'tbsp': 'tbsp',
            'tsp': 'tsp',
            'ml': 'ml',
            'fl_oz': 'fl oz',
            'piece': 'piece',
            'serving': 'serving'
        };

        // Data storage
        let foodDatabase = JSON.parse(localStorage.getItem('foodDatabase')) || [];
        let savedMeals = JSON.parse(localStorage.getItem('savedMeals')) || [];
        let currentMealBuilder = [];
        let todaysMeals = JSON.parse(localStorage.getItem('todaysMeals')) || [];
        let clearedMealsBackup = null; // For undo functionality

        // PIN and Firebase Sync Functions
        function showPinOverlay() {
            document.getElementById('pinOverlay').style.display = 'flex';
            document.getElementById('pinInput').focus();
        }

        function hidePinOverlay() {
            document.getElementById('pinOverlay').style.display = 'none';
        }

        function submitPin() {
            const pin = document.getElementById('pinInput').value.trim();
            
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                alert('Please enter a valid 4-digit PIN');
                return;
            }

            userPin = pin;
            localStorage.setItem('userPin', userPin);
            
            // Connect to Firebase with this PIN
            connectToFirebase();
            hidePinOverlay();
        }

        function changePin() {
            if (confirm('Change PIN? This will disconnect you from your current data.')) {
                localStorage.removeItem('userPin');
                userPin = null;
                if (firebaseRef) {
                    firebaseRef.off(); // Disconnect listeners
                }
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }

        function connectToFirebase() {
            if (!userPin) return;

            // Reference to this user's data in Firebase
            firebaseRef = database.ref(userPin);

            // Load data from Firebase
            firebaseRef.once('value', (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    // Data exists in cloud - load it
                    if (data.foodDatabase) {
                        foodDatabase = data.foodDatabase;
                        localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                    }
                    if (data.savedMeals) {
                        savedMeals = data.savedMeals;
                        localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                    }
                    if (data.todaysMeals) {
                        todaysMeals = data.todaysMeals;
                        localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                    }
                    
                    // Refresh UI
                    renderFoodList();
                    updateFoodSelectors();
                    renderSavedMeals();
                    updateMealSelector();
                    renderDayMeals();
                    
                    console.log('‚úÖ Data loaded from cloud');
                } else {
                    // No data in cloud - upload local data
                    syncToFirebase();
                    console.log('‚úÖ Local data uploaded to cloud');
                }
            });

            // Listen for changes from other devices
            firebaseRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data._lastSync) {
                    const localLastSync = parseInt(localStorage.getItem('lastSync') || '0');
                    if (data._lastSync > localLastSync) {
                        // Remote data is newer - update local
                        if (data.foodDatabase) {
                            foodDatabase = data.foodDatabase;
                            localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                            renderFoodList();
                            updateFoodSelectors();
                        }
                        if (data.savedMeals) {
                            savedMeals = data.savedMeals;
                            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                            renderSavedMeals();
                            updateMealSelector();
                        }
                        if (data.todaysMeals) {
                            todaysMeals = data.todaysMeals;
                            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                            renderDayMeals();
                        }
                        localStorage.setItem('lastSync', data._lastSync.toString());
                    }
                }
            });
        }

        function syncToFirebase() {
            if (!userPin || !firebaseRef) return;

            const timestamp = Date.now();
            
            firebaseRef.set({
                foodDatabase: foodDatabase,
                savedMeals: savedMeals,
                todaysMeals: todaysMeals,
                _lastSync: timestamp
            }).then(() => {
                localStorage.setItem('lastSync', timestamp.toString());
            }).catch((error) => {
                console.error('Sync error:', error);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has a PIN
            if (!userPin) {
                showPinOverlay();
            } else {
                connectToFirebase();
            }

            renderFoodList();
            updateFoodSelectors();
            renderSavedMeals();
            updateMealSelector();
            renderDayMeals();
            
            // Event listeners
            document.getElementById('addFoodForm').addEventListener('submit', addFood);
            document.getElementById('addToMealBuilder').addEventListener('click', addFoodToMealBuilder);
            document.getElementById('saveMealBtn').addEventListener('click', saveMeal);
            document.getElementById('addMealToDay').addEventListener('click', addMealToDay);
            document.getElementById('addFoodToDay').addEventListener('click', addFoodToDay);
            document.getElementById('totalServings').addEventListener('input', calculateMealTotals);
            
            // Update food selector for day page
            updateDayFoodSelector();
            
            // PIN input - submit on Enter key
            document.getElementById('pinInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPin();
                }
            });
        });

        function showPage(pageName) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.add('active');
            event.target.classList.add('active');
        }

        // Convert any unit to grams/ml equivalent
        function convertToBaseUnit(amount, unit) {
            return amount * (UNIT_CONVERSIONS[unit] || 1);
        }

        // Convert from base unit back to specific unit
        function convertFromBaseUnit(baseAmount, unit) {
            return baseAmount / (UNIT_CONVERSIONS[unit] || 1);
        }

        function addFood(e) {
            e.preventDefault();
            
            const fiberValue = parseFloat(document.getElementById('fiber').value) || 0;
            const editingId = document.getElementById('editingFoodId').value;
            const servingAmount = parseFloat(document.getElementById('servingAmount').value);
            const servingUnit = document.getElementById('servingUnit').value;
            
            const protein = parseFloat(document.getElementById('protein').value);
            const carbs = parseFloat(document.getElementById('carbs').value);
            const fats = parseFloat(document.getElementById('fats').value);
            
            // Use custom calories if provided, otherwise auto-calculate
            const caloriesInput = document.getElementById('calories').value;
            const calories = caloriesInput ? parseFloat(caloriesInput) : (protein * 4 + carbs * 4 + fats * 9);
            
            const foodData = {
                name: document.getElementById('foodName').value,
                servingAmount: servingAmount,
                servingUnit: servingUnit,
                protein: protein,
                carbs: carbs,
                fats: fats,
                fiber: fiberValue,
                calories: calories,
                customCalories: !!caloriesInput // Track if user provided custom value
            };

            if (editingId) {
                // Update existing food
                const foodIndex = foodDatabase.findIndex(f => f.id === parseInt(editingId));
                if (foodIndex !== -1) {
                    foodDatabase[foodIndex] = {
                        ...foodDatabase[foodIndex],
                        ...foodData
                    };
                }
                document.getElementById('submitFoodBtn').textContent = 'Add to Database';
                document.getElementById('cancelEditBtn').style.display = 'none';
                document.getElementById('editingFoodId').value = '';
            } else {
                // Add new food
                const food = {
                    id: Date.now(),
                    ...foodData
                };
                foodDatabase.push(food);
            }

            localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
            
            renderFoodList();
            updateFoodSelectors();
            syncToFirebase(); // Sync to cloud
            e.target.reset();
        }

        function editFood(id) {
            const food = foodDatabase.find(f => f.id === id);
            if (!food) return;

            document.getElementById('editingFoodId').value = food.id;
            document.getElementById('foodName').value = food.name;
            document.getElementById('servingAmount').value = food.servingAmount;
            document.getElementById('servingUnit').value = food.servingUnit;
            document.getElementById('protein').value = food.protein;
            document.getElementById('carbs').value = food.carbs;
            document.getElementById('fats').value = food.fats;
            document.getElementById('fiber').value = food.fiber;
            
            // Only populate calories if it was custom (not auto-calculated)
            if (food.customCalories) {
                document.getElementById('calories').value = food.calories;
            } else {
                document.getElementById('calories').value = '';
            }
            
            document.getElementById('submitFoodBtn').textContent = 'Update Food';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // Scroll to form
            document.getElementById('addFoodForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('addFoodForm').reset();
            document.getElementById('editingFoodId').value = '';
            document.getElementById('submitFoodBtn').textContent = 'Add to Database';
            document.getElementById('cancelEditBtn').style.display = 'none';
        }

        function deleteFood(id) {
            if (confirm('Are you sure you want to delete this food?')) {
                foodDatabase = foodDatabase.filter(f => f.id !== id);
                localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                renderFoodList();
                updateFoodSelectors();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderFoodList() {
            const listDiv = document.getElementById('foodList');
            
            if (foodDatabase.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No foods added yet</div>';
                return;
            }

            // Sort alphabetically by name
            const sortedFoods = [...foodDatabase].sort((a, b) => a.name.localeCompare(b.name));

            // Create table
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #2c5282; color: white; position: sticky; top: 0;">
                            <th style="padding: 8px; text-align: left; border-radius: 8px 0 0 0;">Food</th>
                            <th style="padding: 8px; text-align: center;">Serving</th>
                            <th style="padding: 8px; text-align: center;">P</th>
                            <th style="padding: 8px; text-align: center;">C</th>
                            <th style="padding: 8px; text-align: center;">F</th>
                            <th style="padding: 8px; text-align: center;">Fiber</th>
                            <th style="padding: 8px; text-align: center;">Cal</th>
                            <th style="padding: 8px; text-align: center; border-radius: 0 8px 0 0;"></th>
                        </tr>
                    </thead>
                    <tbody class="food-table-body">
            `;

            sortedFoods.forEach((food, index) => {
                const calories = food.calories !== undefined ? food.calories : (food.protein * 4 + food.carbs * 4 + food.fats * 9);
                const servingLabel = `${food.servingAmount} ${UNIT_LABELS[food.servingUnit]}`;
                const rowBg = index % 2 === 0 ? 'white' : '#f8f9fa';

                tableHTML += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #e0e0e0;" class="food-row" data-name="${food.name.toLowerCase()}">
                        <td style="padding: 8px; font-weight: 600; color: #333;">${food.name}</td>
                        <td style="padding: 8px; text-align: center; color: #666;">${servingLabel}</td>
                        <td style="padding: 8px; text-align: center; color: #3b82f6; font-weight: 600;">${food.protein}g</td>
                        <td style="padding: 8px; text-align: center; color: #f59e0b; font-weight: 600;">${food.carbs}g</td>
                        <td style="padding: 8px; text-align: center; color: #10b981; font-weight: 600;">${food.fats}g</td>
                        <td style="padding: 8px; text-align: center; color: #666;">${food.fiber}g</td>
                        <td style="padding: 8px; text-align: center; font-weight: 700;">${calories.toFixed(0)}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button class="btn btn-success" onclick="editFood(${food.id})" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 4px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteFood(${food.id})" style="padding: 4px 8px; font-size: 0.8rem;">Del</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
        }

        function filterFoodList() {
            const searchInput = document.getElementById('foodSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.food-row');
            
            rows.forEach(row => {
                const foodName = row.getAttribute('data-name');
                if (foodName.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function updateFoodSelectors() {
            // Sort foods alphabetically by name
            const sortedFoods = [...foodDatabase].sort((a, b) => a.name.localeCompare(b.name));
            
            const select = document.getElementById('selectFoodForMeal');
            select.innerHTML = '<option value="">Choose a food...</option>' +
                sortedFoods.map(food => 
                    `<option value="${food.name}">${food.name}</option>`
                ).join('');
            
            // Also update day page selector
            updateDayFoodSelector();
        }

        function filterMealFoodDropdown() {
            const searchInput = document.getElementById('searchFoodForMeal').value.toLowerCase();
            const select = document.getElementById('selectFoodForMeal');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                const foodName = option.value.toLowerCase();
                if (foodName === '' || foodName.includes(searchInput)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Auto-select first visible option if only one match
            const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
            if (visibleOptions.length === 1) {
                select.value = visibleOptions[0].value;
            }
        }

        function addFoodToMealBuilder() {
            const foodName = document.getElementById('selectFoodForMeal').value.trim();
            if (!foodName) {
                return; // Silent fail if no food selected
            }

            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;

            currentMealBuilder.push({
                ...food,
                builderId: Date.now(),
                amount: food.servingAmount,
                unit: food.servingUnit
            });

            renderMealBuilder();
            calculateMealTotals();
            
            // Reset the dropdown and search
            document.getElementById('selectFoodForMeal').value = '';
            document.getElementById('searchFoodForMeal').value = '';
            filterMealFoodDropdown(); // Reset filter
        }

        function removeFoodFromBuilder(builderId) {
            currentMealBuilder = currentMealBuilder.filter(f => f.builderId !== builderId);
            renderMealBuilder();
            calculateMealTotals();
        }

        function updateBuilderItem(builderId, field, value) {
            const item = currentMealBuilder.find(f => f.builderId === builderId);
            if (item) {
                item[field] = field === 'unit' ? value : parseFloat(value);
                renderMealBuilder();
                calculateMealTotals();
            }
        }

        function renderMealBuilder() {
            const tableBody = document.getElementById('mealBuilderTableBody');
            
            if (currentMealBuilder.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="empty-state" style="padding: 40px;">No foods in meal yet</td></tr>';
                return;
            }

            tableBody.innerHTML = currentMealBuilder.map((item, index) => {
                // Convert current amount to base units
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                // Get the food's base units
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                // Calculate multiplier
                const multiplier = baseUnits / foodBaseUnits;
                
                const protein = (item.protein * multiplier).toFixed(1);
                const carbs = (item.carbs * multiplier).toFixed(1);
                const fats = (item.fats * multiplier).toFixed(1);
                const fiber = ((item.fiber || 0) * multiplier).toFixed(1);
                
                // Use stored calories if available, otherwise calculate
                const baseCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                const calories = (baseCalories * multiplier).toFixed(0);
                
                // Calculate P/Cal ratio: (protein * 10) / calories
                const pCalRatio = calories > 0 ? ((parseFloat(protein) * 10) / parseFloat(calories)).toFixed(1) : 0;

                const rowBg = index % 2 === 0 ? 'white' : '#f8f9fa';

                return `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 10px; font-weight: 600; color: #333;">${item.name}</td>
                        <td style="padding: 10px; text-align: center;">
                            <input type="number" value="${item.amount}" step="0.1" min="0.1" 
                                style="width: 80px; padding: 6px; border: 2px solid #e0e0e0; border-radius: 6px; text-align: center;"
                                onchange="updateBuilderItem(${item.builderId}, 'amount', this.value)">
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <select onchange="updateBuilderItem(${item.builderId}, 'unit', this.value)"
                                style="width: 100%; padding: 6px; border: 2px solid #e0e0e0; border-radius: 6px;">
                                <option value="g" ${item.unit === 'g' ? 'selected' : ''}>g</option>
                                <option value="oz" ${item.unit === 'oz' ? 'selected' : ''}>oz</option>
                                <option value="lb" ${item.unit === 'lb' ? 'selected' : ''}>lb</option>
                                <option value="cup" ${item.unit === 'cup' ? 'selected' : ''}>cup</option>
                                <option value="tbsp" ${item.unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                                <option value="tsp" ${item.unit === 'tsp' ? 'selected' : ''}>tsp</option>
                                <option value="ml" ${item.unit === 'ml' ? 'selected' : ''}>ml</option>
                                <option value="fl_oz" ${item.unit === 'fl_oz' ? 'selected' : ''}>fl oz</option>
                                <option value="piece" ${item.unit === 'piece' ? 'selected' : ''}>piece</option>
                                <option value="serving" ${item.unit === 'serving' ? 'selected' : ''}>serving</option>
                            </select>
                        </td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #3b82f6;">${protein}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #f59e0b;">${carbs}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #10b981;">${fats}g</td>
                        <td style="padding: 10px; text-align: center; color: #666;">${fiber}g</td>
                        <td style="padding: 10px; text-align: center; font-weight: 700;">${calories}</td>
                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #475569;">${pCalRatio}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button onclick="removeFoodFromBuilder(${item.builderId})" 
                                style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600;">‚úï</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateMealTotals() {
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            currentMealBuilder.forEach(item => {
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                const multiplier = baseUnits / foodBaseUnits;
                
                totalProtein += item.protein * multiplier;
                totalCarbs += item.carbs * multiplier;
                totalFats += item.fats * multiplier;
                totalFiber += (item.fiber || 0) * multiplier;
                
                const itemCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                totalCalories += itemCalories * multiplier;
            });

            const totalServings = parseFloat(document.getElementById('totalServings').value) || 1;
            
            const perServingProtein = totalProtein / totalServings;
            const perServingCarbs = totalCarbs / totalServings;
            const perServingFats = totalFats / totalServings;
            const perServingFiber = totalFiber / totalServings;
            const perServingCalories = totalCalories / totalServings;

            // Calculate P/Cal ratios
            const totalPCal = totalCalories > 0 ? ((totalProtein * 10) / totalCalories).toFixed(1) : 0;
            const perServingPCal = perServingCalories > 0 ? ((perServingProtein * 10) / perServingCalories).toFixed(1) : 0;

            // Update table totals
            document.getElementById('totalProteinTable').textContent = totalProtein.toFixed(1) + 'g';
            document.getElementById('totalCarbsTable').textContent = totalCarbs.toFixed(1) + 'g';
            document.getElementById('totalFatsTable').textContent = totalFats.toFixed(1) + 'g';
            document.getElementById('totalFiberTable').textContent = totalFiber.toFixed(1) + 'g';
            document.getElementById('totalCaloriesTable').textContent = totalCalories.toFixed(0);
            document.getElementById('totalPCalTable').textContent = totalPCal;

            document.getElementById('perServingProteinTable').textContent = perServingProtein.toFixed(1) + 'g';
            document.getElementById('perServingCarbsTable').textContent = perServingCarbs.toFixed(1) + 'g';
            document.getElementById('perServingFatsTable').textContent = perServingFats.toFixed(1) + 'g';
            document.getElementById('perServingFiberTable').textContent = perServingFiber.toFixed(1) + 'g';
            document.getElementById('perServingCaloriesTable').textContent = perServingCalories.toFixed(0);
            document.getElementById('perServingPCalTable').textContent = perServingPCal;
        }

        function saveMeal() {
            const mealName = document.getElementById('mealName').value.trim();
            if (!mealName || currentMealBuilder.length === 0) {
                return; // Silent fail if validation fails
            }

            const totalServings = parseFloat(document.getElementById('totalServings').value) || 1;
            const editingId = document.getElementById('editingMealId').value;

            // Calculate totals
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            currentMealBuilder.forEach(item => {
                const baseUnits = convertToBaseUnit(item.amount, item.unit);
                const foodBaseUnits = convertToBaseUnit(item.servingAmount, item.servingUnit);
                const multiplier = baseUnits / foodBaseUnits;
                
                totalProtein += item.protein * multiplier;
                totalCarbs += item.carbs * multiplier;
                totalFats += item.fats * multiplier;
                totalFiber += (item.fiber || 0) * multiplier;
                
                const itemCalories = item.calories !== undefined ? item.calories : (item.protein * 4 + item.carbs * 4 + item.fats * 9);
                totalCalories += itemCalories * multiplier;
            });

            const mealData = {
                name: mealName,
                totalServings: totalServings,
                foods: currentMealBuilder,
                perServing: {
                    protein: totalProtein / totalServings,
                    carbs: totalCarbs / totalServings,
                    fats: totalFats / totalServings,
                    fiber: totalFiber / totalServings,
                    calories: totalCalories / totalServings
                }
            };

            if (editingId) {
                // Update existing meal
                const mealIndex = savedMeals.findIndex(m => m.id === parseInt(editingId));
                if (mealIndex !== -1) {
                    savedMeals[mealIndex] = {
                        ...savedMeals[mealIndex],
                        ...mealData
                    };
                }
            } else {
                // Create new meal
                const meal = {
                    id: Date.now(),
                    ...mealData
                };
                savedMeals.push(meal);
            }

            localStorage.setItem('savedMeals', JSON.stringify(savedMeals));

            // Clear builder
            cancelMealEdit();
            renderSavedMeals();
            updateMealSelector();
            syncToFirebase(); // Sync to cloud
        }

        function deleteMeal(id) {
            if (confirm('Are you sure you want to delete this meal?')) {
                savedMeals = savedMeals.filter(m => m.id !== id);
                localStorage.setItem('savedMeals', JSON.stringify(savedMeals));
                renderSavedMeals();
                updateMealSelector();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderSavedMeals() {
            const listDiv = document.getElementById('savedMealsList');
            
            if (savedMeals.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No saved meals yet</div>';
                return;
            }

            // Sort alphabetically by name
            const sortedMeals = [...savedMeals].sort((a, b) => a.name.localeCompare(b.name));

            // Create table
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: #2c5282; color: white;">
                            <th style="padding: 8px; text-align: left; border-radius: 8px 0 0 0;">Meal Name</th>
                            <th style="padding: 8px; text-align: center;">Servings</th>
                            <th style="padding: 8px; text-align: center;">P/srv</th>
                            <th style="padding: 8px; text-align: center;">C/srv</th>
                            <th style="padding: 8px; text-align: center;">F/srv</th>
                            <th style="padding: 8px; text-align: center;">Fiber/srv</th>
                            <th style="padding: 8px; text-align: center;">Cal/srv</th>
                            <th style="padding: 8px; text-align: center; border-radius: 0 8px 0 0;"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedMeals.forEach((meal, index) => {
                const calories = meal.perServing.calories || (meal.perServing.protein * 4 + meal.perServing.carbs * 4 + meal.perServing.fats * 9);
                const rowBg = index % 2 === 0 ? 'white' : '#f8f9fa';

                tableHTML += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 8px; font-weight: 600; color: #333;">${meal.name}</td>
                        <td style="padding: 8px; text-align: center; color: #666;">${meal.totalServings}</td>
                        <td style="padding: 8px; text-align: center; color: #3b82f6; font-weight: 600;">${meal.perServing.protein.toFixed(1)}g</td>
                        <td style="padding: 8px; text-align: center; color: #f59e0b; font-weight: 600;">${meal.perServing.carbs.toFixed(1)}g</td>
                        <td style="padding: 8px; text-align: center; color: #10b981; font-weight: 600;">${meal.perServing.fats.toFixed(1)}g</td>
                        <td style="padding: 8px; text-align: center; color: #666;">${meal.perServing.fiber.toFixed(1)}g</td>
                        <td style="padding: 8px; text-align: center; font-weight: 700;">${calories.toFixed(0)}</td>
                        <td style="padding: 8px; text-align: center;">
                            <button class="btn btn-success" onclick="editMeal(${meal.id})" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 4px;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteMeal(${meal.id})" style="padding: 4px 8px; font-size: 0.8rem;">Del</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
        }

        function updateMealSelector() {
            // Sort meals alphabetically by name
            const sortedMeals = [...savedMeals].sort((a, b) => a.name.localeCompare(b.name));
            
            const select = document.getElementById('selectMealForDay');
            select.innerHTML = '<option value="">Choose a meal...</option>' +
                sortedMeals.map(meal => 
                    `<option value="${meal.name}">${meal.name}</option>`
                ).join('');
        }

        function filterDayMealDropdown() {
            const searchInput = document.getElementById('searchMealForDay').value.toLowerCase();
            const select = document.getElementById('selectMealForDay');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                const mealName = option.value.toLowerCase();
                if (mealName === '' || mealName.includes(searchInput)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Auto-select first visible option if only one match
            const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
            if (visibleOptions.length === 1) {
                select.value = visibleOptions[0].value;
            }
        }

        function updateDayFoodSelector() {
            // Sort foods alphabetically by name
            const sortedFoods = [...foodDatabase].sort((a, b) => a.name.localeCompare(b.name));
            
            const select = document.getElementById('selectFoodForDay');
            select.innerHTML = '<option value="">Choose a food...</option>' +
                sortedFoods.map(food => 
                    `<option value="${food.name}">${food.name}</option>`
                ).join('');
        }

        function filterDayFoodDropdown() {
            const searchInput = document.getElementById('searchFoodForDay').value.toLowerCase();
            const select = document.getElementById('selectFoodForDay');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                const foodName = option.value.toLowerCase();
                if (foodName === '' || foodName.includes(searchInput)) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Auto-select first visible option if only one match
            const visibleOptions = Array.from(options).filter(opt => opt.style.display !== 'none' && opt.value !== '');
            if (visibleOptions.length === 1) {
                select.value = visibleOptions[0].value;
            }
        }

        function setDayAddType(type) {
            if (type === 'meal') {
                document.getElementById('mealSelectSection').style.display = 'block';
                document.getElementById('foodSelectSection').style.display = 'none';
                document.getElementById('selectMealTypeBtn').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                document.getElementById('selectFoodTypeBtn').style.background = '#6c757d';
            } else {
                document.getElementById('mealSelectSection').style.display = 'none';
                document.getElementById('foodSelectSection').style.display = 'block';
                document.getElementById('selectMealTypeBtn').style.background = '#6c757d';
                document.getElementById('selectFoodTypeBtn').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        function editMeal(id) {
            const meal = savedMeals.find(m => m.id === id);
            if (!meal) return;

            // Switch to meals page
            showPage('meals');

            // Populate the form
            document.getElementById('editingMealId').value = meal.id;
            document.getElementById('mealName').value = meal.name;
            document.getElementById('totalServings').value = meal.totalServings;
            
            // Load the foods into the builder
            currentMealBuilder = meal.foods.map(food => ({
                ...food,
                builderId: Date.now() + Math.random() // New unique IDs for editing
            }));

            // Update UI
            document.getElementById('mealBuilderTitle').textContent = 'Edit Meal';
            document.getElementById('saveMealBtn').textContent = 'Update Meal';
            document.getElementById('cancelMealEditBtn').style.display = 'block';
            
            renderMealBuilder();
            calculateMealTotals();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelMealEdit() {
            document.getElementById('editingMealId').value = '';
            document.getElementById('mealName').value = '';
            document.getElementById('totalServings').value = '1';
            currentMealBuilder = [];
            
            document.getElementById('mealBuilderTitle').textContent = 'Build Your Meal';
            document.getElementById('saveMealBtn').textContent = 'Save Meal';
            document.getElementById('cancelMealEditBtn').style.display = 'none';
            
            renderMealBuilder();
            calculateMealTotals();
        }

        function addFoodToDay() {
            const foodName = document.getElementById('selectFoodForDay').value.trim();
            if (!foodName) {
                return; // Silent fail
            }

            const food = foodDatabase.find(f => f.name === foodName);
            if (!food) return;

            const amount = parseFloat(document.getElementById('foodAmountForDay').value) || 1;
            const unit = document.getElementById('foodUnitForDay').value;

            // Convert to multiplier for macros
            const baseUnits = convertToBaseUnit(amount, unit);
            const foodBaseUnits = convertToBaseUnit(food.servingAmount, food.servingUnit);
            const multiplier = baseUnits / foodBaseUnits;

            todaysMeals.push({
                id: Date.now(),
                type: 'food',
                foodName: food.name,
                amount: amount,
                unit: unit,
                macros: {
                    protein: food.protein * multiplier,
                    carbs: food.carbs * multiplier,
                    fats: food.fats * multiplier,
                    fiber: (food.fiber || 0) * multiplier,
                    calories: (food.calories !== undefined ? food.calories : (food.protein * 4 + food.carbs * 4 + food.fats * 9)) * multiplier
                }
            });

            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase(); // Sync to cloud
            
            // Reset inputs
            document.getElementById('selectFoodForDay').value = '';
            document.getElementById('searchFoodForDay').value = '';
            document.getElementById('foodAmountForDay').value = '1';
            filterDayFoodDropdown(); // Reset filter
        }

        function addMealToDay() {
            const mealName = document.getElementById('selectMealForDay').value.trim();
            if (!mealName) {
                return; // Silent fail
            }

            const meal = savedMeals.find(m => m.name === mealName);
            if (!meal) return;

            const amount = parseFloat(document.getElementById('mealServingsForDay').value) || 1;
            const unit = document.getElementById('mealUnitForDay').value;

            todaysMeals.push({
                id: Date.now(),
                type: 'meal',
                mealId: meal.id,
                mealName: meal.name,
                amount: amount,
                unit: unit,
                macros: meal.perServing
            });

            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase(); // Sync to cloud
            
            // Reset inputs
            document.getElementById('selectMealForDay').value = '';
            document.getElementById('searchMealForDay').value = '';
            document.getElementById('mealServingsForDay').value = '1';
            filterDayMealDropdown(); // Reset filter
        }

        function removeMealFromDay(id) {
            todaysMeals = todaysMeals.filter(m => m.id !== id);
            localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
            renderDayMeals();
            calculateDayTotals();
            syncToFirebase(); // Sync to cloud
        }

        function updateDayMealAmount(id, amount) {
            const meal = todaysMeals.find(m => m.id === id);
            if (meal) {
                meal.amount = parseFloat(amount);
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                renderDayMeals();
                calculateDayTotals();
                syncToFirebase(); // Sync to cloud
            }
        }

        function updateDayMealUnit(id, unit) {
            const meal = todaysMeals.find(m => m.id === id);
            if (meal) {
                meal.unit = unit;
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                renderDayMeals();
                calculateDayTotals();
                syncToFirebase(); // Sync to cloud
            }
        }

        function renderDayMeals() {
            const listDiv = document.getElementById('dayMealsList');
            
            if (todaysMeals.length === 0) {
                listDiv.innerHTML = '<div class="empty-state">No meals added today</div>';
                calculateDayTotals();
                return;
            }

            // Create table header
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #2c5282; color: white;">
                            <th style="padding: 12px; text-align: left; border-radius: 8px 0 0 0;">Item</th>
                            <th style="padding: 12px; text-align: center;">Amount</th>
                            <th style="padding: 12px; text-align: center;">Protein</th>
                            <th style="padding: 12px; text-align: center;">Carbs</th>
                            <th style="padding: 12px; text-align: center;">Fats</th>
                            <th style="padding: 12px; text-align: center;">Fiber</th>
                            <th style="padding: 12px; text-align: center;">Calories</th>
                            <th style="padding: 12px; text-align: center; border-radius: 0 8px 0 0;"></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            todaysMeals.forEach((item, index) => {
                // Handle legacy data and determine type
                const itemType = item.type || 'meal';
                const displayName = item.mealName || item.foodName || 'Unknown Item';
                const amount = item.amount !== undefined ? item.amount : (item.servings || 1);
                const unit = item.unit || 'serving';
                
                // For meals, apply multiplier; for foods, macros already calculated
                const protein = itemType === 'meal' ? (item.macros.protein * amount).toFixed(1) : item.macros.protein.toFixed(1);
                const carbs = itemType === 'meal' ? (item.macros.carbs * amount).toFixed(1) : item.macros.carbs.toFixed(1);
                const fats = itemType === 'meal' ? (item.macros.fats * amount).toFixed(1) : item.macros.fats.toFixed(1);
                const fiber = itemType === 'meal' ? (item.macros.fiber * amount).toFixed(1) : item.macros.fiber.toFixed(1);
                
                // Calculate calories
                let calories;
                if (itemType === 'food') {
                    calories = item.macros.calories.toFixed(0);
                } else {
                    const calsFromMacros = (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9) * amount;
                    calories = (item.macros.calories ? item.macros.calories * amount : calsFromMacros).toFixed(0);
                }

                // Type badge
                const typeBadge = itemType === 'food' 
                    ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">FOOD</span>'
                    : '<span style="background: #2c5282; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; margin-left: 6px;">MEAL</span>';

                // Alternate row colors
                const rowBg = index % 2 === 0 ? '#f8f9fa' : 'white';

                tableHTML += `
                    <tr style="background: ${rowBg}; border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 12px; font-weight: 600; color: #333;">
                            ${displayName}${typeBadge}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
                                <input type="number" value="${amount}" step="0.1" min="0.1" 
                                    style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                                    onchange="updateDayMealAmount(${item.id}, this.value)" ${itemType === 'food' ? 'disabled' : ''}>
                                <select onchange="updateDayMealUnit(${item.id}, this.value)" 
                                    style="padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.85rem;"
                                    ${itemType === 'food' ? 'disabled' : ''}>
                                    <option value="serving" ${unit === 'serving' ? 'selected' : ''}>srv</option>
                                    <option value="g" ${unit === 'g' ? 'selected' : ''}>g</option>
                                    <option value="oz" ${unit === 'oz' ? 'selected' : ''}>oz</option>
                                    <option value="lb" ${unit === 'lb' ? 'selected' : ''}>lb</option>
                                    <option value="cup" ${unit === 'cup' ? 'selected' : ''}>cup</option>
                                    <option value="tbsp" ${unit === 'tbsp' ? 'selected' : ''}>tbsp</option>
                                    <option value="tsp" ${unit === 'tsp' ? 'selected' : ''}>tsp</option>
                                    <option value="piece" ${unit === 'piece' ? 'selected' : ''}>pc</option>
                                </select>
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #3b82f6;">${protein}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #f59e0b;">${carbs}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: #10b981;">${fats}g</td>
                        <td style="padding: 12px; text-align: center; color: #666;">${fiber}g</td>
                        <td style="padding: 12px; text-align: center; font-weight: 700; font-size: 1.1rem; color: #333;">${calories}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-danger" onclick="removeMealFromDay(${item.id})" 
                                style="padding: 6px 12px; font-size: 0.8rem;">‚úï</button>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = tableHTML;
            calculateDayTotals();
        }

        function calculateDayTotals() {
            let totalProtein = 0;
            let totalCarbs = 0;
            let totalFats = 0;
            let totalFiber = 0;
            let totalCalories = 0;

            todaysMeals.forEach(item => {
                const itemType = item.type || 'meal';
                const amount = item.amount !== undefined ? item.amount : (item.servings || 1);
                
                if (itemType === 'food') {
                    // Foods already have calculated macros
                    totalProtein += item.macros.protein;
                    totalCarbs += item.macros.carbs;
                    totalFats += item.macros.fats;
                    totalFiber += item.macros.fiber;
                    totalCalories += item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9);
                } else {
                    // Meals need to be multiplied by amount
                    totalProtein += item.macros.protein * amount;
                    totalCarbs += item.macros.carbs * amount;
                    totalFats += item.macros.fats * amount;
                    totalFiber += item.macros.fiber * amount;
                    totalCalories += (item.macros.calories || (item.macros.protein * 4 + item.macros.carbs * 4 + item.macros.fats * 9)) * amount;
                }
            });

            // Calculate percentages of calories from each macro
            const proteinPct = totalCalories > 0 ? ((totalProtein * 4 / totalCalories) * 100).toFixed(0) : 0;
            const carbsPct = totalCalories > 0 ? ((totalCarbs * 4 / totalCalories) * 100).toFixed(0) : 0;
            const fatsPct = totalCalories > 0 ? ((totalFats * 9 / totalCalories) * 100).toFixed(0) : 0;

            document.getElementById('dayProtein').textContent = totalProtein.toFixed(1);
            document.getElementById('dayCarbs').textContent = totalCarbs.toFixed(1);
            document.getElementById('dayFats').textContent = totalFats.toFixed(1);
            document.getElementById('dayCalories').textContent = totalCalories.toFixed(0);
            document.getElementById('dayFiber').textContent = totalFiber.toFixed(1);
            
            // Update percentages
            document.getElementById('dayProteinPct').textContent = proteinPct + '%';
            document.getElementById('dayCarbsPct').textContent = carbsPct + '%';
            document.getElementById('dayFatsPct').textContent = fatsPct + '%';
        }

        // Export food database to CSV
        function exportFoodDatabase() {
            const foods = foodDatabase;
            if (foods.length === 0) {
                alert('No foods to export!');
                return;
            }

            const headers = ['id', 'name', 'servingAmount', 'servingUnit', 'protein', 'carbs', 'fats', 'fiber', 'calories', 'customCalories'];
            const csvRows = [
                headers.join(','),
                ...foods.map(f => {
                    return headers.map(h => {
                        const val = f[h];
                        if (val === undefined || val === null) return '';
                        // Escape values that contain commas
                        if (typeof val === 'string' && val.includes(',')) {
                            return `"${val}"`;
                        }
                        return val;
                    }).join(',');
                })
            ];
            
            const csv = csvRows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `food-database-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import food database from CSV
        function importFoodDatabase(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV file is empty or invalid!');
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    // Validate headers
                    const requiredHeaders = ['name', 'servingAmount', 'servingUnit', 'protein', 'carbs', 'fats'];
                    const hasRequiredHeaders = requiredHeaders.every(h => headers.includes(h));
                    
                    if (!hasRequiredHeaders) {
                        alert('CSV must have columns: name, servingAmount, servingUnit, protein, carbs, fats, fiber, calories');
                        return;
                    }

                    const foods = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        // Handle quoted values that may contain commas
                        const values = [];
                        let currentValue = '';
                        let inQuotes = false;
                        
                        for (let char of line) {
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue.trim());
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        values.push(currentValue.trim());

                        const food = {};
                        headers.forEach((h, idx) => {
                            const val = values[idx];
                            if (!val || val === '') return;
                            
                            if (h === 'id') {
                                food[h] = parseInt(val) || Date.now() + i;
                            } else if (['servingAmount', 'protein', 'carbs', 'fats', 'fiber', 'calories'].includes(h)) {
                                food[h] = parseFloat(val) || 0;
                            } else if (h === 'customCalories') {
                                food[h] = val === 'true' || val === '1';
                            } else {
                                food[h] = val;
                            }
                        });

                        // Ensure required fields
                        if (food.name && food.servingAmount && food.servingUnit) {
                            // Set defaults for missing fields
                            food.protein = food.protein || 0;
                            food.carbs = food.carbs || 0;
                            food.fats = food.fats || 0;
                            food.fiber = food.fiber || 0;
                            if (!food.id) food.id = Date.now() + i;
                            if (!food.calories) {
                                food.calories = food.protein * 4 + food.carbs * 4 + food.fats * 9;
                                food.customCalories = false;
                            }
                            foods.push(food);
                        }
                    }

                    if (foods.length === 0) {
                        alert('No valid food entries found in CSV!');
                        return;
                    }

                    // Ask user if they want to replace or merge
                    const replace = confirm(
                        `Import ${foods.length} foods.\n\n` +
                        `Click OK to REPLACE your current database (${foodDatabase.length} foods).\n` +
                        `Click Cancel to MERGE (add new foods without deleting existing ones).`
                    );

                    if (replace) {
                        foodDatabase = foods;
                    } else {
                        // Merge: add foods that don't exist, update foods with same name
                        foods.forEach(newFood => {
                            const existingIndex = foodDatabase.findIndex(f => 
                                f.name.toLowerCase() === newFood.name.toLowerCase()
                            );
                            if (existingIndex >= 0) {
                                // Update existing food but keep the original ID
                                foodDatabase[existingIndex] = {
                                    ...newFood,
                                    id: foodDatabase[existingIndex].id
                                };
                            } else {
                                // Add new food
                                foodDatabase.push(newFood);
                            }
                        });
                    }

                    localStorage.setItem('foodDatabase', JSON.stringify(foodDatabase));
                    renderFoodList();
                    updateFoodSelectors();
                    syncToFirebase(); // Sync to cloud
                    
                    alert(`Successfully imported ${foods.length} foods!`);
                    
                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing CSV: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }

        // Clear day functionality
        function clearDay() {
            if (todaysMeals.length === 0) {
                return; // Nothing to clear
            }

            if (confirm('Clear all meals from today? You can undo this action.')) {
                // Backup current meals for undo
                clearedMealsBackup = JSON.parse(JSON.stringify(todaysMeals));
                
                // Clear the day
                todaysMeals = [];
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                syncToFirebase(); // Sync to cloud
                
                // Show undo button
                document.getElementById('undoClearBtn').style.display = 'block';
                
                // Hide undo button after 10 seconds
                setTimeout(() => {
                    document.getElementById('undoClearBtn').style.display = 'none';
                    clearedMealsBackup = null;
                }, 10000);
                
                renderDayMeals();
                calculateDayTotals();
            }
        }

        function undoClear() {
            if (clearedMealsBackup) {
                todaysMeals = JSON.parse(JSON.stringify(clearedMealsBackup));
                localStorage.setItem('todaysMeals', JSON.stringify(todaysMeals));
                syncToFirebase(); // Sync to cloud
                
                clearedMealsBackup = null;
                document.getElementById('undoClearBtn').style.display = 'none';
                
                renderDayMeals();
                calculateDayTotals();
            }
        }
    </script>
</body>
</html>
